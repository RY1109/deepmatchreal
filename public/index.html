<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeepMatch Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        :root { --ds-blue: #4d6bfe; --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #1f2329; --text-sub: #86909c; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        #app { width: 100%; max-width: 500px; height: 100%; background: var(--bg-card); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg-card); z-index: 10; opacity: 0; transition: opacity 0.3s ease; }
        .page.active { display: flex; opacity: 1; }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar { position: absolute; top: 0; width: 100%; padding: 5px; background: #ffe4e4; color: #d93025; font-size: 0.8rem; text-align: center; display: none; z-index: 999; }

        /* é¦–é¡µæ ·å¼ */
        .home-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .hero-title { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
        .online-badge { background: #e6f7ff; color: var(--ds-blue); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 40px; font-weight: 500; }
        .input-wrapper { width: 100%; background: #fff; border: 1px solid #e5e6eb; border-radius: 16px; padding: 15px; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .input-wrapper:focus-within { border-color: var(--ds-blue); box-shadow: 0 0 0 3px rgba(77, 107, 254, 0.1); }
        textarea { width: 100%; border: none; outline: none; resize: none; min-height: 80px; font-size: 1rem; }
        .btn-start { background: var(--ds-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; float: right; margin-top: 10px; }

        /* èŠå¤©é¡µæ ·å¼ */
        .chat-header { height: 60px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; background: #fff; z-index: 20; }
        .partner-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #eee; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; }
        
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #f9fafe; }
        
        .msg-row { display: flex; gap: 10px; max-width: 100%; }
        .msg-row.me { flex-direction: row-reverse; }
        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; word-break: break-all; position: relative; }
        .msg-row.other .msg-bubble { background: #fff; border: 1px solid #eee; color: var(--text-main); border-top-left-radius: 2px; }
        .msg-row.me .msg-bubble { background: var(--ds-blue); color: white; border-top-right-radius: 2px; }
        .msg-time { font-size: 0.7rem; margin-top: 4px; opacity: 0.7; text-align: right; display: block; }

        /* æ­£åœ¨è¾“å…¥åŠ¨ç”» */
        .typing-indicator { display: none; align-items: center; gap: 4px; margin-left: 46px; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 10px; }
        .dot { width: 6px; height: 6px; background: #ccc; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .input-bar { padding: 12px; background: #fff; display: flex; gap: 10px; border-top: 1px solid #f0f0f0; align-items: flex-end; }
        .chat-input { flex: 1; background: #f5f7f9; border: none; padding: 10px 15px; border-radius: 20px; outline: none; max-height: 100px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç½‘ç»œæ–­å¼€æç¤º -->
        <div id="offline-tip" class="status-bar">ç½‘ç»œå·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿...</div>

        <!-- 1. é¦–é¡µ -->
        <div id="page-home" class="page active">
            <div class="home-content">
                <div class="hero-title">DeepMatch</div>
                <div class="online-badge">ğŸŸ¢ å½“å‰åœ¨çº¿: <span id="online-count">1</span> äºº</div>
                
                <div class="input-wrapper">
                    <textarea id="userInput" placeholder="è¾“å…¥è¯é¢˜ï¼Œä¾‹å¦‚ï¼šæœ‰äººä¸€èµ·ç©é»‘ç¥è¯å—ï¼Ÿ..."></textarea>
                    <div style="overflow: hidden;">
                        <button class="btn-start" onclick="startMatching()">å¼€å§‹åŒ¹é… <i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. åŒ¹é…ä¸­ (Loading) -->
        <div id="page-loading" class="page" style="align-items: center; justify-content: center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--ds-blue);"></i>
            <p style="margin-top: 20px; color: var(--text-sub);">æ­£åœ¨å¯»æ‰¾å¿—åŒé“åˆçš„ä¼™ä¼´...</p>
            <button onclick="location.reload()" style="margin-top: 30px; border:none; background:none; color:#999;">å–æ¶ˆ</button>
        </div>

        <!-- 3. èŠå¤©é¡µ -->
        <div id="page-chat" class="page">
            <header class="chat-header">
                <div class="partner-info">
                    <div class="avatar"><img id="partner-avatar-img" src=""></div>
                    <div>
                        <div style="font-weight: 600;">ç¥ç§˜ç©å®¶</div>
                        <div style="font-size: 0.75rem; color: #22c55e;">â— åŒ¹é…æˆåŠŸ</div>
                    </div>
                </div>
                <i class="fas fa-sign-out-alt" onclick="location.reload()" style="color: #999; cursor: pointer;"></i>
            </header>

            <div class="chat-body" id="chatBody">
                <div style="text-align: center; font-size: 0.8rem; color: #ccc; margin: 10px 0;">
                    å®‰å…¨åŠ å¯†é€šé“å·²å»ºç«‹
                </div>
            </div>

            <div class="typing-indicator" id="typing-indicator">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div> å¯¹æ–¹æ­£åœ¨è¾“å…¥...
            </div>

            <div class="input-bar">
                <input type="text" class="chat-input" id="chatInput" placeholder="å‘æ¶ˆæ¯..." autocomplete="off">
                <button onclick="sendMsg()" style="background:var(--ds-blue); color:white; border:none; width:36px; height:36px; border-radius:50%;"><i class="fas fa-arrow-up"></i></button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRoom = null;
        let myAvatarUrl = '';
        let partnerAvatarUrl = '';
        let typingTimeout = null;

        // --- DiceBear å¤´åƒç”Ÿæˆ API ---
        const getAvatar = (seed) => `https://api.dicebear.com/9.x/notionists/svg?seed=${seed}&backgroundColor=e6f7ff,ffe4e4,e6ffe6`;

        // 1. ç›‘å¬åœ¨çº¿äººæ•°
        socket.on('online_count', (count) => {
            document.getElementById('online-count').innerText = count;
        });

        // 2. ç½‘ç»œçŠ¶æ€ç›‘å¬
        socket.on('connect', () => { document.getElementById('offline-tip').style.display = 'none'; });
        socket.on('disconnect', () => { document.getElementById('offline-tip').style.display = 'block'; });

        // 3. å¼€å§‹åŒ¹é…
        function startMatching() {
            const input = document.getElementById('userInput').value.trim();
            if(!input) return alert("å†™ç‚¹ä»€ä¹ˆå§ï¼");
            
            showPage('page-loading');
            socket.emit('search_match', input);
        }

        // 4. åŒ¹é…æˆåŠŸ
        socket.on('match_found', (data) => {
            currentRoom = data.room;
            // ç”ŸæˆåŒæ–¹å¤´åƒ
            myAvatarUrl = getAvatar(data.myAvatar);
            partnerAvatarUrl = getAvatar(data.partnerAvatar);
            
            document.getElementById('partner-avatar-img').src = partnerAvatarUrl;
            showPage('page-chat');
        });

        // 5. å‘é€æ¶ˆæ¯
        function sendMsg() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;

            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            addMessage(text, 'me', time, myAvatarUrl);
            
            socket.emit('chat_message', { room: currentRoom, msg: text, time: time });
            input.value = '';
        }

        // 6. æ¥æ”¶æ¶ˆæ¯
        socket.on('message_received', (data) => {
            document.getElementById('typing-indicator').style.display = 'none'; // æ”¶åˆ°æ¶ˆæ¯æ—¶éšè—æ­£åœ¨è¾“å…¥
            addMessage(data.msg, 'other', data.time, partnerAvatarUrl);
        });

        // 7. å¤„ç†â€œæ­£åœ¨è¾“å…¥â€
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', () => {
            socket.emit('typing', { room: currentRoom, isTyping: true });
            
            // é˜²æŠ–ï¼šåœæ­¢è¾“å…¥1ç§’åå‘é€åœæ­¢ä¿¡å·
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('typing', { room: currentRoom, isTyping: false });
            }, 1000);
        });

        socket.on('partner_typing', (isTyping) => {
            const indicator = document.getElementById('typing-indicator');
            indicator.style.display = isTyping ? 'flex' : 'none';
            // å¦‚æœå¯¹æ–¹æ­£åœ¨è¾“å…¥ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œé˜²æ­¢æç¤ºè¢«æŒ¡ä½
            if(isTyping) scrollToBottom();
        });

        // å·¥å…·å‡½æ•°ï¼šæ·»åŠ æ¶ˆæ¯åˆ° DOM
        function addMessage(text, type, time, avatar) {
            const chatBody = document.getElementById('chatBody');
            const row = document.createElement('div');
            row.className = `msg-row ${type}`;
            
            // å¯¹æ–¹çš„æ¶ˆæ¯éœ€è¦æ˜¾ç¤ºå¤´åƒ
            let avatarHtml = type === 'other' ? `<div class="avatar"><img src="${avatar}"></div>` : '';
            
            row.innerHTML = `
                ${avatarHtml}
                <div>
                    <div class="msg-bubble">${text}</div>
                    <span class="msg-time">${time}</span>
                </div>
            `;
            
            chatBody.appendChild(row);
            scrollToBottom();
        }

        function scrollToBottom() {
            const chatBody = document.getElementById('chatBody');
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        // å›è½¦å‘é€
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMsg();
        });
    </script>
</body>
</html>